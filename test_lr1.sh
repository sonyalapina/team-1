#!/bin/bash
SCRIPT="./lr1.sh"
TEST_DIR="$(pwd)/test_env"
LOG_DIR="$TEST_DIR/log"
BACKUP_DIR="$TEST_DIR/backup"
mkdir -p "$LOG_DIR" "$BACKUP_DIR"

run_test() {
    local description="$1"
    local input="$2"
    local condition="$3"

    echo "------------------------------------------------------------"
    echo "üîπ TEST: $description"
    echo "------------------------------------------------------------"

    echo -e "$input" | bash "$SCRIPT" > output.log 2>&1
    sleep 1

    if eval "$condition"; then
        echo "‚úÖ PASS ‚Äî $description"
    else
        echo "‚ùå FAIL ‚Äî $description"
        echo "----- Script output -----"
        cat output.log
        echo "--------------------------"
    fi
    echo
    sleep 1
}

# 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ –ø—É—Ç–∏
run_test "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç–æ–≥–æ –ø—É—Ç–∏" "\n\n" \
    "grep -q 'cannot be empty' output.log"

# 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—É—Ç–∏
run_test "–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–∞–ø–∫–∞" "/fake/path\n\n" \
    "grep -q 'does not exist' output.log"

# 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–∏ (–Ω–µ log)
run_test "–ü–∞–ø–∫–∞ –Ω–µ log" "$TEST_DIR\n\n" \
    "grep -q 'is not a log folder' output.log"

# 4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–∏ log
run_test "–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ log" "$LOG_DIR\n10\nn\nn\nn\n" \
    "grep -q 'Folder found' output.log"

# 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ä–æ–≥–∞
run_test "–ü–æ—Ä–æ–≥ 50%" "$LOG_DIR\nn\n50\n" \
    "grep -q 'Threshold set to: 50%' output.log"

# 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–æ–∑–¥–∞—ë–º –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã)
echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
for i in {1..5}; do dd if=/dev/zero of="$LOG_DIR/file_$i.log" bs=1M count=10 &>/dev/null; done

run_test "–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏—è" "$LOG_DIR\nn\n10\ny\n" \
    "grep -q 'archived' output.log"

# 7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
run_test "–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤" "$LOG_DIR\nn\n10\ny\n" \
    "[[ ! \$(ls $LOG_DIR) ]]"

# 8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
run_test "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–æ—Ç–∫–∞–∑)" "$LOG_DIR\nn\n10\nn\n" \
    "grep -q '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã' output.log"

# 9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
run_test "–ü—Ä–æ–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è" "$LOG_DIR\nn\n10\nn\n" \
    "grep -q '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è' output.log"

# üîü –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –Ω–µ–ø—É—Å—Ç–æ–π –ø–∞–ø–∫–µ
echo "test" > "$LOG_DIR/file_test.txt"
run_test "–ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ–ø—É—Å—Ç–æ–π –ø–∞–ø–∫–µ" "$LOG_DIR\ny\n100\n" \
    "grep -q '–ü–∞–ø–∫—É .\\+ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—á–∏—Å—Ç–∏—Ç—å' output.log"

echo "=========================================================="
echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—è–π –≤—ã–≤–æ–¥ –≤—ã—à–µ."
echo "=========================================================="
